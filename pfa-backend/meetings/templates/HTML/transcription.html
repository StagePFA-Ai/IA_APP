{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Transcription ¬∑ MeetingAI</title>

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    :root{
      --brand-bg:#1f2a37;
      --brand-accent:#2563eb;
      --ink-300:#6b7280;
      --ink-600:#374151;
      --panel-bg:#ffffff;
      --page-bg:#f5f5f7;
      --shadow:0 2px 10px rgba(0,0,0,.06);
    }
    body{background:var(--page-bg);min-height:100vh;display:flex}
    /* Sidebar (m√™me style que dashboard) */
    .sidebar{width:260px;background:var(--brand-bg);color:#fff;display:flex;flex-direction:column;padding:20px}
    .sidebar .brand{font-weight:700;font-size:1.25rem;margin-bottom:.25rem}
    .sidebar .muted{opacity:.75;font-size:.9rem;margin-bottom:22px}
    .sidebar a{color:#e5e7eb;text-decoration:none;padding:10px 12px;border-radius:8px;display:block;margin-bottom:6px}
    .sidebar a.active,.sidebar a:hover{background:var(--brand-accent);color:#fff}

    /* Main */
    .main{flex:1;display:flex;flex-direction:column}
    .topbar{background:#fff;box-shadow:var(--shadow);padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
    .content{padding:22px}
    .pane{background:var(--panel-bg);border-radius:12px;box-shadow:var(--shadow)}
    .pane h5{margin:0 0 10px 0}
    .log{white-space:pre-wrap;min-height:160px;max-height:420px;overflow:auto;border-radius:10px;border:1px solid #eee;padding:12px;background:#fafafa}
    .pill{padding:.25rem .6rem;border-radius:999px;font-size:.8rem}
    .pill-live{background:#fee2e2;color:#991b1b}
    .pill-idle{background:#e5e7eb;color:#374151}
    .counter{font-variant:tabular-nums}
    .section-title{font-weight:600;margin-bottom:6px;color:var(--ink-600)}
    .hint{color:var(--ink-300);font-size:.875rem}
    .toolbar{display:flex;gap:.5rem;flex-wrap:wrap}
    .toolbar .btn{min-width:160px}
    @media (max-width: 992px){
      .sidebar{display:none}
    }
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">MeetingAI</div>
    <div class="muted">R√©sum√©s intelligents</div>
    <nav>
      <a href="{% url 'dashboard' %}">Tableau de bord</a>
      <a href="{% url 'meetings' %}">R√©unions</a>
      <a href="{% url 'calendar' %}">Calendrier</a>
      <a href="{% url 'settings' %}">Param√®tres</a>
    </nav>
    <div class="mt-auto small text-white-50">¬© {% now "Y" %} Local</div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <header class="topbar">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-secondary d-md-none" id="toggleSidebar">‚ò∞</button>
        <h1 class="h5 m-0">
          {{ reunion.titre }} ¬∑ {{ reunion.date_r|date:"d/m/Y" }} {{ reunion.heure_r|time:"H:i" }}
        </h1>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a class="btn btn-outline-primary btn-sm" href="{% url 'view_meeting' reunion.id %}">D√©tails</a>
        <a class="btn btn-outline-dark btn-sm" href="{% url 'generate_report' reunion.id %}">G√©n√©rer le rapport</a>
        <a class="btn btn-primary btn-sm" href="{% url 'meeting_report_view' reunion.id %}"> Aper√ßu rapport</a>
      </div>
    </header>

    <main class="content container-fluid">
      {% if messages %}
        <div class="mb-3">
          {% for message in messages %}
            <div class="alert alert-{{ message.tags }} mb-2">{{ message }}</div>
          {% endfor %}
        </div>
      {% endif %}

      <div class="row g-3">
        <!-- 1) Contr√¥le -->
        <div class="col-12 col-lg-4">
          <div class="pane p-3">
            <h5>Capture & Contr√¥le</h5>

            <div class="d-flex align-items-center justify-content-between mb-2">
              <span id="badgeState" class="pill pill-idle">Au repos</span>
              <span class="text-muted small">Dur√©e : <span id="timer" class="counter">00:00</span></span>
            </div>

            <div class="section-title">Param√®tres</div>
            <div class="d-flex gap-2">
              <select id="lang" class="form-select">
                <option value="fr" selected>Fran√ßais</option>
                <option value="en">English</option>
                <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
              </select>
              <input id="maxMins" type="number" class="form-control" placeholder="Dur√©e max (min)" min="1">
            </div>

            <div class="section-title mt-3">Actions</div>
            <div class="toolbar">
              <button id="btnToggle" class="btn btn-primary"> D√©marrer la capture</button>
              <button id="btnSave" class="btn btn-outline-dark" disabled> Enregistrer</button>
              <button id="btnClear" class="btn btn-light"> Effacer l‚Äôaffichage</button>
            </div>

            <div id="info" class="hint mt-2"></div>
            <hr class="my-3">
            <div class="hint">
              
              
            </div>
          </div>
        </div>

        <!-- 2) Transcription live -->
        <div class="col-12 col-lg-4">
          <div class="pane p-3">
            <div class="d-flex align-items-center justify-content-between">
              <h5>Transcription (temps r√©el)</h5>
              <span class="text-muted small">{{ reunion.get_status_display }}</span>
            </div>
            <div id="transcription" class="log">
              {% if transcription %}
                {{ transcription.text_transcrit }}
              {% endif %}
            </div>
          </div>
        </div>

        <!-- 3) R√©sum√© -->
        <div class="col-12 col-lg-4">
          <div class="pane p-3 d-flex flex-column" style="height:100%">
            <h5>R√©sum√© de la r√©union</h5>
            <div id="summary" class="log flex-grow-1">
              {% if resume %}
                {{ resume.text_resume }}
              {% endif %}
            </div>
            <!-- Bouton plac√© SOUS la zone de r√©sum√© -->
            <div class="d-grid gap-2 mt-2">
              <button id="btnSumm" class="btn btn-outline-primary" disabled> Produire / Mettre √† jour le r√©sum√©</button>
            </div>
            <div class="hint mt-2">
              
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // ---------- util ----------
    function getCookie(name) {
      const value = `; ${document.cookie}`;
      const parts = value.split(`; ${name}=`);
      if (parts.length === 2) return parts.pop().split(';').shift();
    }
    function fmtTime(sec) {
      const m = Math.floor(sec / 60).toString().padStart(2, '0');
      const s = Math.floor(sec % 60).toString().padStart(2, '0');
      return `${m}:${s}`;
    }

    // ---------- √©l√©ments ----------
    const btnToggle = document.getElementById('btnToggle');
    const btnSumm   = document.getElementById('btnSumm');
    const btnSave   = document.getElementById('btnSave');
    const btnClear  = document.getElementById('btnClear');
    const badge     = document.getElementById('badgeState');
    const timerEl   = document.getElementById('timer');
    const infoEl    = document.getElementById('info');
    const transDiv  = document.getElementById('transcription');
    const sumDiv    = document.getElementById('summary');
    const langSel   = document.getElementById('lang');
    const maxMins   = document.getElementById('maxMins');

    // ---------- √©tat ----------
    let ws = null;
    let stream = null;
    let audioCtx = null;
    let source   = null;
    let processor = null;
    let running = false;
    let t0 = 0;
    let tick = null;
    let autoStopTimer = null;
    let accumulatedText = [];

    const WS_URL = "{{ webrtc_ws_url|default:'/ws/transcription/' }}";

    function setState(on) {
      running = on;
      if (on) {
        badge.textContent = "Enregistrement‚Ä¶";
        badge.classList.remove('pill-idle');
        badge.classList.add('pill-live');
        btnToggle.textContent = " Arr√™ter la capture";
        btnSumm.disabled = true;   // r√©sum√© dispo apr√®s arr√™t
        btnSave.disabled = true;
      } else {
        badge.textContent = "Au repos";
        badge.classList.remove('pill-live');
        badge.classList.add('pill-idle');
        btnToggle.textContent = "D√©marrer la capture";
        btnSumm.disabled = false;
        btnSave.disabled = false;
      }
    }
    function logInfo(s) { infoEl.textContent = s || ""; }
    function appendTrans(line) {
      if (!line) return;
      accumulatedText.push(line);
      transDiv.textContent += (transDiv.textContent ? "\n" : "") + "üó£Ô∏è " + line;
      transDiv.scrollTop = transDiv.scrollHeight;
    }
    function setSummary(text) {
      sumDiv.textContent = text || "";
      sumDiv.scrollTop = sumDiv.scrollHeight;
    }

    // Downsample Float32 @inRate -> Float32 @16kHz
    function downsampleTo16k(float32Buffer, inSampleRate) {
      if (inSampleRate === 16000) return new Float32Array(float32Buffer);
      const ratio = inSampleRate / 16000;
      const outLen = Math.round(float32Buffer.length / ratio);
      const out = new Float32Array(outLen);
      let inPos = 0;
      for (let i = 0; i < outLen; i++) {
        const nextInPos = Math.round((i + 1) * ratio);
        let sum = 0, count = 0;
        for (; inPos < nextInPos && inPos < float32Buffer.length; inPos++) {
          sum += float32Buffer[inPos];
          count++;
        }
        out[i] = count ? (sum / count) : 0;
      }
      return out;
    }

    async function start() {
      try {
        // 1) WebSocket
        if (!ws || ws.readyState === WebSocket.CLOSED) {
          ws = new WebSocket((location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + WS_URL);
          ws.binaryType = "arraybuffer";
          ws.onmessage = (e) => {
            try {
              const data = JSON.parse(e.data);
              if (data.type === "transcription") appendTrans(data.message);
              else if (data.type === "summary")   setSummary(data.message);
              else if (data.type === "info")      transDiv.textContent += (transDiv.textContent ? "\n" : "") + data.message;
            } catch(_) {}
          };
          await new Promise(res => ws.onopen = res);
        }

        // 2) Micro
        stream = await navigator.mediaDevices.getUserMedia({
          audio: {
            channelCount: 1,
            echoCancellation: false,
            noiseSuppression: false,
            autoGainControl: true
          }
        });

        // 3) WebAudio ‚Üí Float32 16 kHz ‚Üí WS
        audioCtx  = new (window.AudioContext || window.webkitAudioContext)({ sampleRate: 48000 });
        source    = audioCtx.createMediaStreamSource(stream);
        processor = audioCtx.createScriptProcessor(4096, 1, 1);
        processor.onaudioprocess = (ev) => {
          if (!ws || ws.readyState !== WebSocket.OPEN) return;
          const input = ev.inputBuffer.getChannelData(0);             // Float32 @ ~48k
          const pcm16k = downsampleTo16k(input, audioCtx.sampleRate); // Float32 @ 16k
          ws.send(pcm16k.buffer);                                     // binaire (ArrayBuffer)
        };
        source.connect(processor);
        processor.connect(audioCtx.destination);

        // 4) action start
        if (ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({ action: "start", lang: (langSel.value || "fr") }));
        }

        // 5) UI
        transDiv.textContent += (transDiv.textContent ? "\n" : "") + " Transcription d√©marr√©e‚Ä¶";
        t0 = Date.now();
        timerEl.textContent = "00:00";
        clearInterval(tick);
        tick = setInterval(() => {
          const sec = (Date.now() - t0) / 1000;
          timerEl.textContent = fmtTime(sec);
        }, 250);

        clearTimeout(autoStopTimer);
        const mins = parseInt(maxMins.value || "0", 10);
        if (mins > 0) autoStopTimer = setTimeout(stop, mins * 60 * 1000);

        setState(true);
        logInfo("");

      } catch (err) {
        logInfo("Erreur micro/WebSocket : " + (err?.message || err));
        setState(false);
      }
    }

    function stop() {
      try { processor && processor.disconnect(); } catch(_) {}
      try { source && source.disconnect(); } catch(_) {}
      try { audioCtx && audioCtx.close(); } catch(_) {}
      try { if (stream) stream.getTracks().forEach(t => t.stop()); } catch(_) {}
      try { if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify({ action: "stop" })); } catch(_) {}

      clearInterval(tick);
      clearTimeout(autoStopTimer);
      setState(false);
      transDiv.textContent += (transDiv.textContent ? "\n" : "") + "‚èπÔ∏è Transcription arr√™t√©e.";
    }

    function toggle() {
      if (running) stop(); else start();
    }

    async function summarize() {
      if (!ws || ws.readyState !== WebSocket.OPEN) {
        return logInfo("Socket ferm√©. Relance l‚Äôenregistrement au moins une fois.");
      }
      const lang = langSel.value || "fr";
      ws.send(JSON.stringify({ action: "summarize", lang }));
      logInfo("R√©sum√© en cours‚Ä¶");
    }

    async function saveAll() {
      const text = accumulatedText.join("\n");
      const summary = sumDiv.textContent.trim();
      if (!text) return logInfo("Rien √† enregistrer.");

      const fd = new FormData();
      fd.append("text", text);
      fd.append("summary", summary);
      fd.append("lang", langSel.value || "fr");

      try {
        const resp = await fetch("{% url 'save_transcription' reunion.id %}", {
          method: "POST",
          headers: { "X-CSRFToken": getCookie('csrftoken') },
          body: fd
        });
        const data = await resp.json();
        if (!resp.ok || !data.ok) throw new Error(data.error || "Erreur de sauvegarde.");
        logInfo(" Transcription enregistr√©e.");
      } catch (e) {
        logInfo(" " + (e?.message || e));
      }
    }

    function clearDisplay() {
      transDiv.textContent = "";
      sumDiv.textContent = "";
      accumulatedText = [];
      logInfo("");
    }

    // ---------- bind ----------
    document.getElementById('toggleSidebar')?.addEventListener('click', () => {
      const s = document.querySelector('.sidebar');
      s.style.display = (s.style.display === 'none' ? 'flex' : 'none');
    });

    btnToggle.addEventListener('click', toggle);
    btnSumm  .addEventListener('click', summarize);
    btnSave  .addEventListener('click', saveAll);
    btnClear .addEventListener('click', clearDisplay);

    window.addEventListener('beforeunload', () => { try { if (running) stop(); } catch(_){} });
  </script>
</body>
</html>
