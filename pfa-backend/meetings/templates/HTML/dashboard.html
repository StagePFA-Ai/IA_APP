{% load static %}
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard · MeetingAI</title>

  <!-- Bootstrap & Chart.js -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <link rel="stylesheet" href="{% static 'css/style.css' %}">
  <style>
    body{background:#f5f5f7;min-height:100vh;display:flex}
    .sidebar{width:260px;background:#1f2a37;color:#fff;display:flex;flex-direction:column;padding:20px}
    .sidebar .brand{font-weight:700;font-size:1.3rem;margin-bottom:6px}
    .sidebar .muted{opacity:.75;font-size:.9rem;margin-bottom:22px}
    .sidebar a{color:#e5e7eb;text-decoration:none;padding:10px 12px;border-radius:8px;display:block;margin-bottom:6px}
    .sidebar a.active,.sidebar a:hover{background:#2563eb;color:#fff}
    .main{flex:1;display:flex;flex-direction:column}
    .topbar{background:#fff;box-shadow:0 2px 8px rgba(0,0,0,.06);padding:14px 20px;display:flex;align-items:center;justify-content:space-between}
    .content{padding:22px}
    .card-kpi{border:0;border-radius:14px;box-shadow:0 4px 14px rgba(0,0,0,.06)}
    .kpi-title{font-size:.9rem;color:#6b7280}
    .kpi-value{font-size:2rem;font-weight:700;color:#111827}
    .btn-primary{background:#2563eb;border-color:#2563eb}
  </style>
</head>
<body>

  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="brand">MeetingAI</div>
    <div class="muted">Résumés intelligents</div>
    <nav>
      <a href="{% url 'dashboard' %}" class="active">Tableau de bord</a>
      <a href="/meetings">Réunions</a>
      <a href="/calendar">Calendrier</a>
      <a href="/settings">Paramètres</a>
    </nav>
    <div class="mt-auto small text-white-50">© {% now "Y" %} Local</div>
  </aside>

  <!-- MAIN -->
  <div class="main">
    <!-- TOPBAR -->
    <header class="topbar">
      <div class="d-flex align-items-center gap-2">
        <button class="btn btn-sm btn-outline-secondary d-md-none" id="toggleSidebar">☰</button>
        <h1 class="h5 m-0">Bienvenue{% if request.user.is_authenticated %}, {{ request.user.first_name|default:request.user.username }}{% endif %}</h1>
      </div>
      <div class="d-flex align-items-center gap-2">
        <a href="/nouvelle-reunion" class="btn btn-primary btn-sm">Nouvelle réunion</a>
        <a href="/settings" class="btn btn-outline-primary btn-sm">Profil</a>
      </div>
    </header>

    <!-- CONTENT -->
    <main class="content container-fluid">
      <h2 class="h4 mb-3">Dashboard</h2>

      <!-- KPI -->
      <div class="row g-3">
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card card-kpi p-3">
            <div class="kpi-title">Total réunions</div>
            <div class="kpi-value">{{ kpis.total_meetings }}</div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card card-kpi p-3">
            <div class="kpi-title">Total heures (audio)</div>
            <div class="kpi-value">{{ kpis.heures }}</div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card card-kpi p-3">
            <div class="kpi-title">Résumés générés</div>
            <div class="kpi-value">{{ kpis.Résumés }}</div>
          </div>
        </div>
        <div class="col-12 col-sm-6 col-lg-3">
          <div class="card card-kpi p-3">
            <div class="kpi-title">Actions à venir</div>
            <div class="kpi-value">{{ kpis.actions }}</div>
          </div>
        </div>
      </div>

      <!-- CHARTS -->
      <div class="row g-3 mt-1">
        <div class="col-12 col-lg-8">
          <div class="card p-3 card-kpi">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h3 class="h6 m-0">Réunions par mois</h3>
            </div>
            <canvas id="chartMeetings"></canvas>
          </div>
        </div>

        <div class="col-12 col-lg-4">
          <div class="card p-3 card-kpi">
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h3 class="h6 m-0">Bienvenue sur MeetingAI</h3>
            </div>
            
            <div class="text-muted small mt-2">
              suivez l’évolution mensuelle et accédez au calendrier pour planifier ou démarrer une réunion.
            </div>
          </div>
        </div>
      </div>

      <!-- (Optionnel) Liste récente -->
      {% if recent_meetings %}
      <div class="card card-kpi p-3 mt-3">
        <h3 class="h6">Réunions récentes</h3>
        <div class="table-responsive">
          <table class="table table-sm align-middle mb-0">
            <thead><tr><th>Titre</th><th>Date</th><th>Heure</th><th>Statut</th></tr></thead>
            <tbody>
              {% for r in recent_meetings %}
              <tr>
                <td>{{ r.titre }}</td>
                <td>{{ r.date_r|date:"d/m/Y" }}</td>
                <td>{{ r.heure_r|time:"H:i" }}</td>
                <td><span class="badge bg-secondary">{{ r.get_status_display }}</span></td>

              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}
    </main>
  </div>

  <script>
    // Toggle sidebar on small screens
    document.getElementById('toggleSidebar')?.addEventListener('click', () => {
      const s = document.querySelector('.sidebar');
      s.style.display = (s.style.display === 'none' ? 'flex' : 'none');
    });

    // Line chart: meetings per month
    const labelsLine = {{ chart1_labels|safe }};
    const dataLine   = {{ chart1_data|safe }};
    const ctxLine    = document.getElementById('chartMeetings').getContext('2d');
    new Chart(ctxLine, {
      type: 'line',
      data: {
        labels: labelsLine,
        datasets: [{
          label: 'Réunions / mois',
          data: dataLine,
          tension: 0.35,
          fill: true,
          borderColor: 'rgba(37,99,235,1)',
          backgroundColor: 'rgba(37,99,235,0.15)',
          pointRadius: 3
        }]
      },
      options: {
        responsive: true,
        scales: {
          y: { beginAtZero: true, ticks: { precision: 0 } }
        }
      }
    });

    // Doughnut chart: status distribution (optional)
    const statusLabels = {{ status_labels|default:"[]"|safe }};
    const statusData   = {{ status_data|default:"[]"|safe }};
    if (Array.isArray(statusLabels) && statusLabels.length) {
      const ctxD = document.getElementById('chartStatus').getContext('2d');
      new Chart(ctxD, {
        type: 'doughnut',
        data: {
          labels: statusLabels,
          datasets: [{
            data: statusData,
            backgroundColor: [
              'rgba(37,99,235,0.9)',   // planifié
              'rgba(16,185,129,0.9)',  // en cours
              'rgba(107,114,128,0.9)', // terminé
              'rgba(239,68,68,0.9)',   // annulé
              'rgba(245,158,11,0.9)'   // reporté
            ]
          }]
        },
        options: {
          responsive: true,
          plugins: { legend: { position: 'bottom' } }
        }
      });
    } else {
      document.getElementById('chartStatus').parentElement.innerHTML +=
        '<div class="text-muted">Aucune donnée de statut pour le moment.</div>';
      document.getElementById('chartStatus').remove();
    }
  </script>
</body>
</html>
